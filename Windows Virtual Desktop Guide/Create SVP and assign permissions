#This script creates an Azure Service Principal and assigns it permissions on the WVD tenant/workspace and specified Azure subscription.
#Author: Maran Verweij - Ingram Micro
#Version: 1.0

#Run as Administrator
#Fill in the variables below

#$UserName requires the account that was previously used to create the WVD tenant/workspace,
#if this account uses MFA 2 authentication screens will popup when executing the script.
$UserName = "name@tenant.onmicrosoft.com" #Azure account name in UPN format, 
$Password = "password" #Password for Azure account
$Azure_sub = "" #Azure subscription ID

$SVP_Displayname = "SVP_WVD_1" #Display name for the Service principal
$SVP_Password = "password" #Maximum length is approx. 850 characters (varies slightly based on string complexity), utilizing the maximum amount is highly recommended for security purposes
$WVD_Workspace_Name = "name" #WVD Workspace/Tenant name, as created previously

#No more manual input required as of this line
$Execution_Policy = Get-ExecutionPolicy #Get current Execution policy
Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope CurrentUser -Force 

if (!(Get-InstalledModule Microsoft.RDInfra.RDPowerShell -ErrorAction silentlycontinue)) {
    Install-Module -Name Microsoft.RDInfra.RDPowerShell -Confirm:$False -Force -AllowClobber
    }
Import-Module -Name Microsoft.RDInfra.RDPowerShell

if (!(Get-InstalledModule Az -ErrorAction silentlycontinue)) {
    Install-Module -Name Az -Confirm:$False -Force -AllowClobber
    }

Set-ExecutionPolicy -ExecutionPolicy $Execution_Policy -Scope CurrentUser -Force #Restore initial Execution policy

[System.Security.SecureString]$SecPwd = ConvertTo-SecureString -String $Password -AsPlainText -Force #Create creds from previous input
$Credentials = New-Object -TypeName "System.Management.Automation.PSCredential" -ArgumentList $UserName, $SecPwd

Try {
Add-RdsAccount -DeploymentUrl https://rdbroker.wvd.microsoft.com -Credential $Credentials #Authenticate to WVD management site
Connect-AzAccount -Credential $Credentials -Subscription $Azure_sub #Authenticate to Azure (Az Powershell module)
}

Catch {
Add-RdsAccount -DeploymentUrl https://rdbroker.wvd.microsoft.com #Authenticate to WVD management site
Connect-AzAccount -Subscription $Azure_sub #Authenticate to Azure (Az Powershell module)
} 

$credentials = New-Object Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential -Property @{ StartDate=Get-Date; EndDate=Get-Date -Year 3000; Password=$SVP_Password}
$SVP = New-AzAdServicePrincipal -DisplayName $SVP_Displayname -PasswordCredential $credentials

Start-Sleep 10

#WVD CMDlet to assign permissions to svp
New-RdsRoleAssignment -RoleDefinitionName "RDS Contributor" -ApplicationId $SVP.ApplicationId -TenantGroupName "Default Tenant Group" -TenantName $WVD_Workspace_Name

#Assign azure sub contributor permissions
New-AzRoleAssignment -RoleDefinitionName "Contributor" -ApplicationId $SVP.ApplicationId

Write-Host "Document the following string, this is the Service Principal (Application) ID:" $SVP.ApplicationId
